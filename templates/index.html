<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ebebek Barkod Takip</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      :root { --brand-primary:#0072ce; --brand-accent:#ff8200; --bg-light:#ffffff; --text-light:#111827; --muted-light:#6b7280; --bg-dark:#0f172a; --card-dark:#1e293b; --text-dark:#e6edf3; --border-dark:#334155; --muted-dark:#94a3b8; --input-dark:#1e293b; --progress-dark:#1f2937; }
      [data-theme="dark"] { --bg:var(--bg-dark); --card:var(--card-dark); --text:var(--text-dark); --border:var(--border-dark); --muted:var(--muted-dark); --input-bg:var(--input-dark); --progress-bg:var(--progress-dark); }
      [data-theme="light"] { --bg:var(--bg-light); --card:#ffffff; --text:var(--text-light); --border:#e2e8f0; --muted:var(--muted-light); --input-bg:#ffffff; --progress-bg:#e5e7eb; }
      body{background:var(--bg);color:var(--text)}
      .card{background:var(--card);border-color:var(--border);color:var(--text)}
      .card h6,.card-title,.card-text{color:var(--text)} .text-muted{color:var(--muted)!important} .text-body-secondary{color:var(--muted)!important}
      .navbar{background:var(--brand-primary)!important}.navbar .navbar-brand,.navbar .btn{color:#fff!important}
      .navbar .btn-outline-light{color:#fff!important;border-color:rgba(255,255,255,.5)!important;background:transparent!important}
      .navbar .btn-outline-light:hover{background:rgba(255,255,255,.2)!important;border-color:#fff!important}
      .navbar .btn-warning:hover{background:#ffc107!important;color:#000!important}
      .btn-brand{background:var(--brand-primary);color:#fff;border:none}.btn-brand:hover{background:#005aa3;color:#fff}
      .btn-accent{background:var(--brand-accent);color:#fff;border:none}.btn-accent:hover{background:#e67300;color:#fff}
      .nav-tabs{border-color:var(--border)} .nav-tabs .nav-link{color:var(--muted);background:transparent;border-color:transparent}
      .nav-tabs .nav-link:hover{border-color:var(--border);color:var(--text)} .nav-tabs .nav-link.active{color:#fff;background:var(--brand-primary);border-color:var(--brand-primary)}
      .tab-content{background:var(--card);border:1px solid var(--border)!important;color:var(--text)}
      .progress{background:var(--progress-bg)} .progress-brand .progress-bar{background:var(--brand-primary)} .progress-accent .progress-bar{background:var(--brand-accent)}
      .form-control,.form-select{background:var(--input-bg);color:var(--text);border:1px solid var(--border)}
      .form-control:focus,.form-select:focus{background:var(--input-bg);color:var(--text);border-color:var(--brand-primary);box-shadow:0 0 0 .2rem rgba(0,114,206,.15)}
      .form-control::placeholder{color:var(--muted)}
      .list-group-item{background:var(--card);color:var(--text);border-color:var(--border)} .badge.bg-dark{background:#2d3a53!important;color:#fff} [data-theme="light"] .badge.bg-dark{background:#374151!important}
      .alert{background:var(--card);border-color:var(--border);color:var(--text)} .alert-success{background:#064e3b;border-color:#059669;color:#d1fae5} .alert-danger{background:#7f1d1d;border-color:#dc2626;color:#fee2e2} .alert-warning{background:#78350f;border-color:#d97706;color:#fef3c7} .alert-info{background:#1e3a8a;border-color:#3b82f6;color:#dbeafe}
      .flash-add{box-shadow:0 0 0 0.25rem rgba(25,135,84,.25)!important;border-color:#198754!important}
      .list-compact li{display:flex;justify-content:space-between;gap:.5rem} #toastWrap{position:fixed;right:1rem;bottom:1rem;z-index:1080}
      .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:38px;height:38px;border-radius:8px;transition:all 0.3s ease;font-size:20px}
      .icon-btn:hover{background:rgba(255,255,255,0.2)!important;border-color:rgba(255,255,255,0.5)!important;transform:scale(1.1)}
      #btn-shutdown:hover{background:rgba(220,38,38,0.2)!important;border-color:rgba(220,38,38,0.5)!important;transform:scale(1.1)}
      .icon{width:18px;height:18px}
      hr{border-color:var(--border)} .border,.border-top,.border-bottom,.border-start,.border-end{border-color:var(--border)!important}
      #manualKategoriBtn{display:flex;justify-content:space-between;align-items:center;font-weight:600;background-color:var(--brand-primary)!important;border-color:var(--brand-primary)!important}
      #manualKategoriBtn:hover{background-color:#005aa3!important;border-color:#005aa3!important}
      #manualKategoriBtn::after{display:none!important}
      .dropdown-toggle-icon{font-size:10px;opacity:0.7;transition:transform 0.2s;margin-left:8px}
      .dropdown-toggle[aria-expanded="true"] .dropdown-toggle-icon{transform:rotate(180deg)}
      .dropdown-menu{min-width:100%;border:2px solid var(--brand-primary)!important;box-shadow:0 4px 12px rgba(0,0,0,0.15)!important;margin-top:4px!important}
      .dropdown-item:hover{background-color:var(--brand-primary)!important;color:#fff!important}
      .dropdown-item.active{background-color:var(--brand-primary)!important;color:#fff!important}
      .btn-qty{width:36px;height:36px;padding:0;border-width:2px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;transition:all 0.2s ease;cursor:pointer}
      .btn-qty.plus{color:#fff;border-color:#0072ce;background-color:#0072ce;box-shadow:0 2px 4px rgba(0,114,206,0.3)}
      .btn-qty.plus:hover{background-color:#005aa3;border-color:#005aa3;transform:scale(1.05);box-shadow:0 4px 8px rgba(0,114,206,0.4)}
      .btn-qty.plus:active{transform:scale(0.95)}
      .btn-qty.minus{color:#fff;border-color:#ff8200;background-color:#ff8200;box-shadow:0 2px 4px rgba(255,130,0,0.3)}
      .btn-qty.minus:hover{background-color:#e67300;border-color:#e67300;transform:scale(1.05);box-shadow:0 4px 8px rgba(255,130,0,0.4)}
      .btn-qty.minus:active{transform:scale(0.95)}
      .btn-qty.delete{color:#fff;border-color:#dc2626;background-color:#dc2626;box-shadow:0 2px 4px rgba(220,38,38,0.3);font-size:16px}
      .btn-qty.delete:hover{background-color:#b91c1c;border-color:#b91c1c;transform:scale(1.05);box-shadow:0 4px 8px rgba(220,38,38,0.4)}
      .btn-qty.delete:active{transform:scale(0.95)}
      /* Arama kartlarƒ± i√ßin dark theme uyumu */
      #productList .card{background:var(--card);border-color:var(--border);color:var(--text)}
      #productList .card-title,#productList .card-text{color:var(--text)}
      #productList .form-control{background:var(--input-bg);color:var(--text);border-color:var(--border)}
      #productList label{color:var(--text)}
      /* Modal dark theme uyumu */
      .modal-content{background:var(--card)!important;border-color:var(--border)!important;color:var(--text)!important}
      .modal-header{border-color:var(--border)!important}
      .modal-title{color:var(--text)!important}
      .modal-body{color:var(--text)!important}
      .modal-body p{color:var(--text)!important}
      [data-theme="dark"] .btn-close{filter:invert(1)}
      [data-theme="light"] .btn-close{filter:none}
    </style>
    <script>
      // Eƒüer sekme window.open() ile a√ßƒ±lmadƒ±ysa, otomatik olarak window.open() ile a√ß ve eski sekmeyi kapat
      (function(){
        // sessionStorage flag: bu sayfa zaten window.open() ile a√ßƒ±ldƒ±ysa tekrar a√ßma
        if(sessionStorage.getItem('js-opened')) return;
        // window.opener varsa zaten window.open() ile a√ßƒ±lmƒ±≈ü demektir
        if(window.opener) {
          sessionStorage.setItem('js-opened', '1');
          return;
        }
        // Normal a√ßƒ±ldƒ±ysa: window.open() ile a√ß ve eski sekmeyi kapat
        try {
          const newWin = window.open(window.location.href, 'appwin');
          if(newWin) {
            sessionStorage.setItem('js-opened', '1');
            // Eski sekmeyi kapat (kƒ±sa bir gecikme ile)
            setTimeout(() => {
              try { window.close(); } catch(e) {}
            }, 100);
            // Yeni pencereye odaklan
            if(newWin.focus) newWin.focus();
          }
        } catch(e) {
          console.log('Window a√ßma hatasƒ±:', e);
        }
      })();
    </script>
  </head>
  <body>
    <div id="toastWrap" aria-live="polite" aria-atomic="true"></div>
    <nav class="navbar navbar-expand-lg">
      <div class="container-fluid">
        <a class="navbar-brand fw-semibold" href="#">Ebebek</a>
        <div class="d-flex gap-2">
          <a class="btn btn-accent" href="{{ url_for('save_route') }}">Excel'e Kaydet</a>
          <form method="post" action="{{ url_for('reset_all') }}" class="d-inline">
            <button type="submit" class="btn btn-warning">Sƒ±fƒ±rla</button>
          </form>
          <button id="btn-theme" class="btn btn-outline-light icon-btn" type="button" title="Tema">üåô</button>
          <button id="btn-shutdown" class="btn btn-outline-light icon-btn" type="button" title="Kapat">üö™</button>
        </div>
      </div>
    </nav>

    <div class="container py-4">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <div class="row g-3 mb-3">
        <div class="col-md-3">
          <div class="card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Barkodsuzlar</h6>
                <span id="stat-barkodsuz" class="badge text-bg-primary">{{ stats.barkodsuz }}</span>
              </div>
              <div class="progress progress-brand" style="height:6px">
                <div id="pb-barkodsuz" class="progress-bar" role="progressbar" style="width: {{ (stats.barkodsuz / (stats.toplam or 1) * 100)|round(0) }}%"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Kayƒ±tsƒ±zlar</h6>
                <span id="stat-kayitsiz" class="badge text-bg-secondary">{{ stats.kayitsiz }}</span>
              </div>
              <div class="progress" style="height:6px">
                <div id="pb-kayitsiz" class="progress-bar bg-secondary" role="progressbar" style="width: {{ (stats.kayitsiz / (stats.toplam or 1) * 100)|round(0) }}%"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Hasarlƒ±lar</h6>
                <span id="stat-hasarli" class="badge text-bg-danger">{{ stats.hasarli }}</span>
              </div>
              <div class="progress" style="height:6px">
                <div id="pb-hasarli" class="progress-bar bg-danger" role="progressbar" style="width: {{ (stats.hasarli / (stats.toplam or 1) * 100)|round(0) }}%"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card h-100">
            <div class="card-body d-flex flex-column justify-content-center">
              <div class="text-muted small">Toplam Kayƒ±t</div>
              <div id="stat-toplam" class="fs-4 fw-semibold">{{ stats.toplam }}</div>
            </div>
          </div>
        </div>
      </div>

      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="barkodsuz-tab" data-bs-toggle="tab" data-bs-target="#barkodsuz" type="button" role="tab">Barkodsuzlar</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="kayitsiz-tab" data-bs-toggle="tab" data-bs-target="#kayitsiz" type="button" role="tab">Kayƒ±tsƒ±zlar</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="hasarli-tab" data-bs-toggle="tab" data-bs-target="#hasarli" type="button" role="tab">Hasarlƒ±lar</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="ara-tab" data-bs-toggle="tab" data-bs-target="#ara" type="button" role="tab">Ara</button>
        </li>
      </ul>
      <div class="tab-content p-3 border border-top-0" id="myTabContent">
        <div class="tab-pane fade show active" id="barkodsuz" role="tabpanel">
          <form id="form-barkodsuz" class="row g-3" method="post" action="{{ url_for('add_barkodsuz_route') }}">
            <div class="col-auto">
              <label class="visually-hidden">Barkod</label>
              <input type="text" name="barkod" class="form-control" placeholder="11/13 haneli barkod" required>
            </div>
            <div class="col-auto">
              <button type="submit" class="btn btn-brand mb-3">Ekle</button>
            </div>
          </form>
          <div id="card-barkodsuz" class="card mt-3 d-none" style="max-width: 620px;">
            <div class="row g-0">
              <div class="col-md-4 d-flex align-items-center p-2">
                <img id="img-barkodsuz" src="" class="img-fluid rounded-start" alt="urun" width="288" height="288">
              </div>
              <div class="col-md-8">
                <div class="card-body">
                  <h5 id="title-barkodsuz" class="card-title"></h5>
                  <p id="brand-barkodsuz" class="card-text mb-1"><small class="text-body-secondary"></small></p>
                  <p id="stock-barkodsuz" class="card-text mb-1"></p>
                  <p id="price-barkodsuz" class="card-text mb-1"></p>
                  <p id="meta-barkodsuz" class="card-text"><small></small></p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="kayitsiz" role="tabpanel">
          <form id="form-kayitsiz" class="row g-3" method="post" action="{{ url_for('add_kayitsiz_route') }}">
            <div class="col-auto">
              <label class="visually-hidden">Barkod</label>
              <input type="text" name="barkod" class="form-control" placeholder="EBHJ ile ba≈ülayan 14 karakter" required>
            </div>
            <div class="col-auto">
              <button type="submit" class="btn btn-brand mb-3">Ekle</button>
            </div>
          </form>
        </div>
        <div class="tab-pane fade" id="hasarli" role="tabpanel">
          <form id="form-hasarli" class="row g-3" method="post" action="{{ url_for('add_hasarli_route') }}">
            <div class="col-auto">
              <label class="visually-hidden">Barkod</label>
              <input type="text" name="barkod" class="form-control" placeholder="11/13 haneli barkod" required>
            </div>
            <div class="col-auto">
              <button type="submit" class="btn btn-accent mb-3">Ekle</button>
            </div>
          </form>
          <div id="card-hasarli" class="card mt-3 d-none" style="max-width: 620px;">
            <div class="row g-0">
              <div class="col-md-4 d-flex align-items-center p-2">
                <img id="img-hasarli" src="" class="img-fluid rounded-start" alt="urun" width="288" height="288">
              </div>
              <div class="col-md-8">
                <div class="card-body">
                  <h5 id="title-hasarli" class="card-title"></h5>
                  <p id="brand-hasarli" class="card-text mb-1"><small class="text-body-secondary"></small></p>
                  <p id="stock-hasarli" class="card-text mb-1"></p>
                  <p id="price-hasarli" class="card-text mb-1"></p>
                  <p id="meta-hasarli" class="card-text"><small></small></p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="ara" role="tabpanel">
          <div class="search-box mb-3">
            <form id="form-search" class="row g-3">
              <div class="col-md-10">
                <input type="text" id="searchInput" class="form-control" placeholder="√úr√ºn adƒ± veya barkod girin..." required>
              </div>
              <div class="col-md-2">
                <button type="submit" id="searchBtn" class="btn btn-primary w-100">üîç Ara</button>
              </div>
            </form>
          </div>
          <div id="searchResults" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="mb-0">Bulunan √úr√ºnler</h6>
              <span id="resultsCount" class="badge bg-primary">0 √ºr√ºn</span>
            </div>
            <div id="productList" class="row g-3"></div>
            <div id="pagination" class="mt-3 d-flex justify-content-center gap-2" style="display:none!important;"></div>
          </div>
        </div>
      </div>

      <!-- Sabit: T√ºm sekmelerin altƒ±nda Eklenenler (yatay liste) -->
      <div class="mt-3">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Eklenenler</h6>
              <div class="d-flex align-items-center gap-2">
                <span id="total-added" class="badge text-bg-success">0</span>
                <button class="btn btn-sm btn-brand" type="button" data-bs-toggle="collapse" data-bs-target="#manualCollapse">Manuel Ekle</button>
              </div>
            </div>
            <ul id="list-total" class="list-group list-compact"></ul>
            <hr>
            <div id="manualCollapse" class="collapse">
            <form id="form-manual" class="row gy-2 gx-2 align-items-end">
              <div class="col-md-3">
                <label class="form-label small">Kategori</label>
                <div class="dropdown w-100">
                  <button class="btn btn-primary dropdown-toggle w-100 d-flex justify-content-between align-items-center" type="button" id="manualKategoriBtn" data-bs-toggle="dropdown" aria-expanded="false" style="background-color: var(--brand-primary); border-color: var(--brand-primary);">
                    <span id="manualKategoriText">Barkodsuz</span>
                    <span class="dropdown-toggle-icon">‚ñº</span>
                  </button>
                  <ul class="dropdown-menu w-100" aria-labelledby="manualKategoriBtn">
                    <li><a class="dropdown-item active" href="#" data-kategori="barkodsuz">Barkodsuz</a></li>
                    <li><a class="dropdown-item" href="#" data-kategori="hasarli">Hasarlƒ±</a></li>
                    <li><a class="dropdown-item" href="#" data-kategori="kayitsiz">Kayƒ±tsƒ±z</a></li>
                  </ul>
                  <input type="hidden" name="kategori" id="manualKategori" value="barkodsuz">
                </div>
              </div>
              <div class="col-md-2" id="manualBarkodGroup" style="display:none;">
                <label class="form-label small">Kayƒ±tsƒ±z Barkod</label>
                <input name="barkod" id="manualBarkod" class="form-control" placeholder="EBHJ ile ba≈ülayan 14 karakter">
              </div>
              <div class="col-md-4" id="manualTitleGroup">
                <label class="form-label small">√úr√ºn Adƒ±</label>
                <input name="title" id="manualTitle" class="form-control" placeholder="√úr√ºn adƒ±nƒ± girin">
              </div>
              <div class="col-md-1" id="manualAdetGroup">
                <label class="form-label small">Adet</label>
                <input name="adet" id="manualAdet" type="number" min="1" value="1" class="form-control" placeholder="1">
              </div>
              <div class="col-md-2">
                <button class="btn btn-accent w-100" type="submit">Ekle</button>
              </div>
            </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function showToast(message, type){
        const wrap = document.getElementById('toastWrap');
        const toastEl = document.createElement('div');
        toastEl.className = 'toast align-items-center text-bg-' + (type||'primary');
        toastEl.setAttribute('role','status');
        toastEl.setAttribute('aria-live','polite');
        toastEl.setAttribute('aria-atomic','true');
        toastEl.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
        wrap.appendChild(toastEl);
        new bootstrap.Toast(toastEl, { delay: 2000 }).show();
      }
      
      function resize96(url, mult){
        if(!url) return '';
        const m = Math.max(1, parseInt(mult||2,10));
        const size = 96*m;
        return url.replace('/96/96/', `/${size}/${size}/`);
      }

      function updateStats(stats){
        const toplam = stats.toplam||0;
        const pct = (v)=> toplam ? Math.round((v/toplam)*100) : 0;
        document.getElementById('stat-barkodsuz').innerText = stats.barkodsuz;
        document.getElementById('stat-kayitsiz').innerText = stats.kayitsiz;
        document.getElementById('stat-hasarli').innerText = stats.hasarli;
        document.getElementById('stat-toplam').innerText = toplam;
        document.getElementById('pb-barkodsuz').style.width = pct(stats.barkodsuz)+'%';
        document.getElementById('pb-kayitsiz').style.width = pct(stats.kayitsiz)+'%';
        document.getElementById('pb-hasarli').style.width = pct(stats.hasarli)+'%';
      }

      function continuousScan(formId, inputName, endpoint, onCard){
        const form = document.getElementById(formId);
        const input = form.querySelector(`[name="${inputName}"]`);
        const queue = [];
        const processingBarkods = new Set(); // ≈ûu anda i≈ülenmekte olan barkodlar
        let processing = false;
        input.setAttribute('autocomplete','off');
        input.focus();

        const processNext = async ()=>{
          if(processing || queue.length===0) return;
          
          // Queue'dan i≈ülenmemi≈ü bir barkod bul (aynƒ± barkod i√ßin e≈üzamanlƒ± istek g√∂ndermeyi √∂nle)
          let barkod = null;
          let barkodIndex = -1;
          for(let i = 0; i < queue.length; i++){
            if(!processingBarkods.has(queue[i])){
              barkod = queue[i];
              barkodIndex = i;
              break;
            }
          }
          
          // ƒ∞≈ülenmemi≈ü barkod yoksa bekle
          if(!barkod || barkodIndex === -1) return;
          
          // Barkodu queue'dan √ßƒ±kar ve i≈ülem listesine ekle
          queue.splice(barkodIndex, 1);
          processingBarkods.add(barkod);
          processing = true;
          
          try{
            const res = await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({barkod})});
            let data = null;
            try{
              data = await res.json();
            }catch(parseErr){
              console.error('Tarama yanƒ±tƒ± √ß√∂z√ºmlenemedi', parseErr);
            }
            if(!res.ok || !(data && data.ok)){
              const msg = (data && data.message) ? data.message : 'Hata';
              showToast(msg,'danger');
            }else{
              updateStats(data.stats);
              if(onCard) onCard(data);
              if(formId === 'form-barkodsuz'){
                const c = document.getElementById('card-barkodsuz');
                c.classList.add('flash-add','border','border-2');
                setTimeout(()=>c.classList.remove('flash-add','border','border-2'),800);
              }
              if(formId === 'form-hasarli'){
                const c = document.getElementById('card-hasarli');
                c.classList.add('flash-add','border','border-2');
                setTimeout(()=>c.classList.remove('flash-add','border','border-2'),800);
              }
            }
          }catch(err){
            showToast('Aƒü hatasƒ±','danger');
          }finally{
            processingBarkods.delete(barkod);
            processing = false;
            input.focus();
            // Kƒ±sa bir gecikme ile bir sonrakini i≈üle (backend'in i≈ülemesine zaman ver)
            setTimeout(()=>processNext(), 50);
          }
        };

        form.addEventListener('submit',(e)=>{
          e.preventDefault();
          const barkod = input.value.trim();
          input.value='';
          if(!barkod) {
            input.focus();
            return;
          }
          queue.push(barkod);
          processNext();
        });
      }

      let totalAdded = 0;
      function renderEklenenler(list){
        const ul = document.getElementById('list-total');
        ul.innerHTML=''; totalAdded=0;
        list.forEach((it)=>{
          const kategori = (it.kategori||'').toString();
          const barkodVal = (it.barkod??'').toString();
          if(!kategori || !barkodVal){
            console.warn('Eksik kayƒ±t bilgisi atlandƒ±', it);
            return;
          }
          totalAdded += (kategori==='kayitsiz'?1:(it.adet||1));
          const key = `${kategori}:${barkodVal}`;
          const badgeClass = kategori==='barkodsuz'?'text-bg-primary':(kategori==='hasarli'?'text-bg-danger':'text-bg-secondary');
          
          // Excel formatƒ±: "{brand} - {title}" formatƒ±nda g√∂ster
          const brand = it.brand || '';
          const title = it.title || barkodVal;
          let displayText = title;
          if (kategori !== 'kayitsiz' && brand) {
            displayText = `${brand} - ${title}`;
          }
          
          // HTML escape i√ßin
          const escapeHtml = (text) => {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
          };
          
          const li = document.createElement('li');
          li.className='list-group-item d-flex align-items-center justify-content-between gap-2';
          li.innerHTML = `
            <div class=\"d-flex align-items-center gap-2 flex-grow-1\">\n              <span class=\"badge ${badgeClass} text-uppercase\">${kategori}</span>\n              <span class=\"text-truncate\" style=\"max-width:60%\">${escapeHtml(displayText)}</span>\n            </div>\n            <div class=\"d-flex align-items-center gap-2\">\n              <span class=\"badge bg-dark\">adet ${it.adet||1}</span>\n              ${kategori!=='kayitsiz' ? `<button class=\"btn btn-qty plus\" data-inc=\"${escapeHtml(key)}\">+</button>` : ''}\n              ${kategori!=='kayitsiz' ? `<button class=\"btn btn-qty minus\" data-dec=\"${escapeHtml(key)}\">‚àí</button>` : ''}\n              <button class=\"btn btn-qty delete\" data-key=\"${escapeHtml(key)}\" title=\"Sil\">√ó</button>\n            </div>`;
          ul.appendChild(li);
        });
        document.getElementById('total-added').innerText = totalAdded;
      }

      function mount(){
        continuousScan('form-barkodsuz','barkod','/api/add/barkodsuz', (data)=>{
          const c = document.getElementById('card-barkodsuz');
          document.getElementById('img-barkodsuz').src = resize96(data.card.image_link,3);
          document.getElementById('title-barkodsuz').innerText = data.card.title||'';
          document.getElementById('brand-barkodsuz').innerHTML = `<small class="text-body-secondary">${data.card.brand||''}</small>`;
          document.getElementById('stock-barkodsuz').innerText = `Stok: ${data.card.stock_status||''}`;
          document.getElementById('price-barkodsuz').innerText = `Fiyat: ${data.card.price||''}`;
          document.getElementById('meta-barkodsuz').innerHTML = `<small>Barkod: ${data.card.barkod} | Adet: ${data.adet}</small>`;
          c.classList.remove('d-none');
          renderEklenenler(data.eklenenler||[]);
        });
        
        continuousScan('form-hasarli','barkod','/api/add/hasarli', (data)=>{
          const c = document.getElementById('card-hasarli');
          document.getElementById('img-hasarli').src = resize96(data.card.image_link,3);
          document.getElementById('title-hasarli').innerText = data.card.title||'';
          document.getElementById('brand-hasarli').innerHTML = `<small class="text-body-secondary">${data.card.brand||''}</small>`;
          document.getElementById('stock-hasarli').innerText = `Stok: ${data.card.stock_status||''}`;
          document.getElementById('price-hasarli').innerText = `Fiyat: ${data.card.price||''}`;
          document.getElementById('meta-hasarli').innerHTML = `<small>Barkod: ${data.card.barkod} | Adet: ${data.adet}</small>`;
          c.classList.remove('d-none');
          renderEklenenler(data.eklenenler||[]);
        });
        
        continuousScan('form-kayitsiz','barkod','/api/add/kayitsiz', (data)=>{
          renderEklenenler(data.eklenenler||[]);
        });
        
        // Manuel ekleme formu - kategoriye g√∂re dinamik
        const formManual = document.getElementById('form-manual');
        const manualKategori = document.getElementById('manualKategori');
        const manualKategoriBtn = document.getElementById('manualKategoriBtn');
        const manualKategoriText = document.getElementById('manualKategoriText');
        const manualTitleGroup = document.getElementById('manualTitleGroup');
        const manualAdetGroup = document.getElementById('manualAdetGroup');
        const manualTitle = document.getElementById('manualTitle');
        const manualAdet = document.getElementById('manualAdet');
        const manualBarkodGroup = document.getElementById('manualBarkodGroup');
        const manualBarkod = document.getElementById('manualBarkod');
        
        // Dropdown menu item'lara tƒ±klandƒ±ƒüƒ±nda
        document.querySelectorAll('[data-kategori]').forEach(item => {
          item.addEventListener('click', (e) => {
            e.preventDefault();
            const kategori = e.target.getAttribute('data-kategori');
            const kategoriText = e.target.textContent;
            
            // Hidden input'u g√ºncelle
            manualKategori.value = kategori;
            // Buton metnini g√ºncelle
            manualKategoriText.textContent = kategoriText;
            // Dropdown'ƒ± kapat
            const dropdown = bootstrap.Dropdown.getInstance(manualKategoriBtn);
            if (dropdown) dropdown.hide();
            
            // Formu g√ºncelle
            updateManualForm();
            
            // Aktif item'ƒ± i≈üaretle
            document.querySelectorAll('[data-kategori]').forEach(i => i.classList.remove('active'));
            e.target.classList.add('active');
          });
        });
        
        function updateManualForm() {
          const kategori = manualKategori.value;
          if (kategori === 'kayitsiz') {
            // Kayƒ±tsƒ±z: Sadece EBHJ barkod
            manualTitleGroup.style.display = 'none';
            manualAdetGroup.style.display = 'none';
            manualBarkodGroup.style.display = 'block';
            manualBarkod.placeholder = 'EBHJ ile ba≈ülayan 14 karakter (√∂rn: EBHJ1003942527)';
            manualBarkod.pattern = '^EBHJ[0-9]{10}$';
            manualTitle.required = false;
            manualAdet.required = false;
          } else {
            // Barkodsuz/Hasarlƒ±: √úr√ºn adƒ± ve adet (barkod yok)
            manualTitleGroup.style.display = 'block';
            manualAdetGroup.style.display = 'block';
            manualBarkodGroup.style.display = 'none';
            manualTitle.placeholder = '√úr√ºn adƒ±nƒ± girin';
            manualAdet.placeholder = '1';
            manualTitle.required = false;
            manualAdet.required = false;
          }
        }
        
        updateManualForm(); // ƒ∞lk y√ºklemede
        
        formManual.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const kategori = manualKategori.value;
          
          // Kayƒ±tsƒ±z i√ßin validation
          if (kategori === 'kayitsiz') {
            const barkod = manualBarkod.value.trim();
            if (!barkod) {
              showToast('Kayƒ±tsƒ±z i√ßin barkod gereklidir.', 'danger');
              return;
            }
            if (!barkod.startsWith('EBHJ') || barkod.length !== 14) {
              showToast('Kayƒ±tsƒ±z barkod EBHJ ile ba≈ülamalƒ± ve 14 karakter olmalƒ±dƒ±r.', 'danger');
              return;
            }
          }
          
          const fd = new FormData(formManual);
          const payload = Object.fromEntries(fd.entries());
          
          // Kayƒ±tsƒ±z i√ßin gereksiz alanlarƒ± kaldƒ±r
          if (kategori === 'kayitsiz') {
            delete payload.title;
            delete payload.adet;
          } else {
            // Barkodsuz/Hasarlƒ± i√ßin barkod yoksa bo≈ü string g√∂nder
            delete payload.barkod;
          }
          
          try{
            const res = await fetch('/api/eklenenler/manual_add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
            const data = await res.json();
            if(!res.ok||!data.ok){showToast(data.message||'Hata','danger');return}
            updateStats(data.stats||{});
            renderEklenenler(data.eklenenler||[]);
            formManual.reset();
            updateManualForm(); // Reset sonrasƒ± formu g√ºncelle
          }catch(err){showToast('Aƒü hatasƒ±','danger')}
        });
        
        const pendingQtyKeys = new Set();

        document.getElementById('list-total').addEventListener('click', async (e)=>{
          const btn = e.target.closest('button[data-key]');
          if(btn) {
            const key = btn.getAttribute('data-key');
            try{
              const res = await fetch('/api/eklenenler/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key})});
              const data = await res.json();
              if(data && data.stats) updateStats(data.stats);
              if(data && data.eklenenler) renderEklenenler(data.eklenenler||[]);
              if(!res.ok||!data.ok){showToast(data.message||'Hata','danger');return}
            }catch(err){showToast('Aƒü hatasƒ±','danger')}
            return;
          }
          
          const btnDec = e.target.closest('button[data-dec]');
          if(btnDec) {
            const key = btnDec.getAttribute('data-dec');
            if(!key) return;
            if(pendingQtyKeys.has(key)) return;
            pendingQtyKeys.add(key);
            try{
              const res = await fetch('/api/eklenenler/decrement',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key})});
              let data = null;
              try{
                data = await res.json();
              }catch(parseErr){
                console.log('Azaltma yanƒ±tƒ± √ß√∂z√ºmlenemedi', parseErr);
                showToast('Yanƒ±t √ß√∂z√ºmlenemedi','danger');
                return;
              }
              
              // √ñnce hata kontrol√º yap
              if(!res.ok || !(data && data.ok)){
                const msg = (data && data.message) ? data.message : 'Hata';
                showToast(msg,'danger');
                // Hata durumunda bile eklenenler listesi varsa g√ºncelle (400 hatasƒ± i√ßin)
                if(data && data.eklenenler) renderEklenenler(data.eklenenler||[]);
                if(data && data.stats) updateStats(data.stats);
              } else {
                // Ba≈üarƒ±lƒ± durumda g√ºncelle
                if(data && data.stats) updateStats(data.stats);
                if(data && data.eklenenler) renderEklenenler(data.eklenenler||[]);
              }
            }catch(err){
              showToast('Aƒü hatasƒ±','danger');
            }finally{
              pendingQtyKeys.delete(key);
            }
            return;
          }
          
          const btnInc = e.target.closest('button[data-inc]');
          if(btnInc) {
            const key = btnInc.getAttribute('data-inc');
            if(!key) return;
            if(pendingQtyKeys.has(key)) return;
            pendingQtyKeys.add(key);
            try{
              const res = await fetch('/api/eklenenler/increment',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key})});
              let data = null;
              try{
                data = await res.json();
              }catch(parseErr){
                console.log('Arttƒ±rma yanƒ±tƒ± √ß√∂z√ºmlenemedi', parseErr);
              }
              if(data && data.stats) updateStats(data.stats);
              if(data && data.eklenenler) renderEklenenler(data.eklenenler||[]);
              if(!res.ok || !(data && data.ok)){
                const msg = (data && data.message) ? data.message : 'Hata';
                showToast(msg,'danger');
              }
            }catch(err){
              showToast('Aƒü hatasƒ±','danger');
            }finally{
              pendingQtyKeys.delete(key);
            }
          }
        });
        
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        
        // Tema iconunu hepsiburada gibi yap (üåô/‚òÄÔ∏è)
        function updateThemeIcon(theme) {
          const btn = document.getElementById('btn-theme');
          if (theme === 'dark') {
            btn.textContent = 'üåô';
          } else {
            btn.textContent = '‚òÄÔ∏è';
          }
        }
        
        updateThemeIcon(savedTheme);
        
        document.getElementById('btn-theme').addEventListener('click', ()=>{
          const cur = document.documentElement.getAttribute('data-theme');
          const next = cur==='dark'?'light':'dark';
          document.documentElement.setAttribute('data-theme', next);
          localStorage.setItem('theme', next);
          updateThemeIcon(next);
        });
        
        document.getElementById('btn-shutdown').addEventListener('click', async ()=>{
          if(!confirm('Uygulamayƒ± kapatmak istediƒüinize emin misiniz? T√ºm veriler temizlenecek.')) return;
          
          try {
            await fetch('/api/shutdown', { method: 'POST' });
            
            // Tarayƒ±cƒ± sekmesini kapat (birka√ß y√∂ntem dene)
            setTimeout(() => {
              try {
                window.close();
              } catch (e) {
                // window.close() bazƒ± tarayƒ±cƒ±larda √ßalƒ±≈ümayabilir
                // Alternatif: Kendi kendini a√ßan pencereler kapatƒ±labilir
                console.log('Pencere kapatƒ±lamadƒ±, sayfayƒ± yenile');
              }
            }, 1000);
            
          } catch (error) {
            console.error('Kapatma hatasƒ±:', error);
            showToast('Bir hata olu≈ütu. L√ºtfen tekrar deneyin.', 'danger');
          }
        });
        
        renderEklenenler({{ eklenenler|tojson|safe }});
        
        // Arama sekmesi fonksiyonlarƒ±
        window.currentProducts = [];
        window.currentPage = 1;
        const productsPerPage = 16;
        
        // Form submit ve Enter tu≈üu ile arama
        document.getElementById('form-search').addEventListener('submit', function(e) {
          e.preventDefault();
          searchProducts();
        });
        
        async function searchProducts() {
          const searchInput = document.getElementById('searchInput');
          const searchTerm = searchInput.value.trim();
          
          if (!searchTerm) {
            showToast('L√ºtfen arama terimi girin', 'warning');
            return;
          }
          
          const searchBtn = document.getElementById('searchBtn');
          const originalText = searchBtn.innerHTML;
          searchBtn.disabled = true;
          searchBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Aranƒ±yor...';
          
          try {
            const res = await fetch('/api/search', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ q: searchTerm })
            });
            
            const data = await res.json();
            
            if (!res.ok || !data.ok) {
              showToast(data.message || 'Arama ba≈üarƒ±sƒ±z', 'danger');
              return;
            }
            
            window.currentProducts = data.products || [];
            window.currentPage = 1;
            
            if (window.currentProducts.length === 0) {
              document.getElementById('searchResults').style.display = 'none';
              showToast('√úr√ºn bulunamadƒ±', 'warning');
              return;
            }
            
            document.getElementById('searchResults').style.display = 'block';
            document.getElementById('resultsCount').textContent = `${window.currentProducts.length} √ºr√ºn`;
            
            displayProducts(window.currentProducts);
            
          } catch (error) {
            console.error('Arama hatasƒ±:', error);
            showToast('Arama sƒ±rasƒ±nda hata olu≈ütu', 'danger');
          } finally {
            searchBtn.disabled = false;
            searchBtn.innerHTML = originalText;
          }
        }
        
        function displayProducts(products) {
          showPage(window.currentPage, products);
        }
        
        function showPage(page, products) {
          const productList = document.getElementById('productList');
          const totalPages = Math.ceil(products.length / productsPerPage);
          
          const startIndex = (page - 1) * productsPerPage;
          const endIndex = startIndex + productsPerPage;
          const productsToShow = products.slice(startIndex, endIndex);
          
          productList.innerHTML = productsToShow.map((product, idx) => {
            const hasImage = product.image_link && product.image_link.trim() !== '';
            const imgUrl = hasImage ? resize96(product.image_link, 2) : '';
            const globalIndex = startIndex + idx;
            
            // HTML escape i√ßin
            const escapeHtml = (text) => {
              const div = document.createElement('div');
              div.textContent = text || '';
              return div.innerHTML;
            };
            
            return `
              <div class="col-md-4 col-sm-6 mb-3">
                <div class="card h-100" style="max-width: 400px;">
                  <div class="row g-0 h-100">
                    ${hasImage ? `
                    <div class="col-4 d-flex align-items-center p-2">
                      <img src="${escapeHtml(imgUrl)}" class="img-fluid rounded-start" alt="${escapeHtml(product.title || '')}" style="max-height: 150px; object-fit: contain;" onerror="this.style.display='none';">
                    </div>
                    ` : ''}
                    <div class="${hasImage ? 'col-8' : 'col-12'} d-flex flex-column">
                      <div class="card-body p-2 flex-grow-1 d-flex flex-column">
                        <div class="flex-grow-1">
                          <h6 class="card-title mb-1" style="font-size: 14px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${escapeHtml(product.title || '')}</h6>
                          ${product.brand ? `<p class="card-text mb-1" style="font-size: 12px;"><small class="text-body-secondary">${escapeHtml(product.brand)}</small></p>` : ''}
                          ${product.stock_status ? `<p class="card-text mb-1" style="font-size: 12px;">Stok: ${escapeHtml(product.stock_status)}</p>` : ''}
                          ${product.price ? `<p class="card-text mb-1" style="font-size: 12px;">Fiyat: ${escapeHtml(product.price)}</p>` : ''}
                        </div>
                        <div class="mt-auto">
                          <div class="d-flex align-items-center gap-2 mb-2">
                            <label class="small mb-0" style="color: var(--text);">Adet:</label>
                            <input type="number" id="qty-${globalIndex}" class="form-control form-control-sm" value="1" min="1" style="width: 60px;" onchange="updateProductQty(${globalIndex}, this.value)">
                          </div>
                          <button class="btn btn-sm btn-primary w-100" onclick="addProductToList(${globalIndex})" style="min-height: 32px;">Listeye Ekle</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }).join('');
          
          // Sayfalama butonlarƒ±
          const paginationDiv = document.getElementById('pagination');
          if (totalPages > 1) {
            let paginationHTML = '';
            
            if (page > 1) {
              paginationHTML += `<button class="btn btn-sm btn-outline-primary" onclick="window.showPage(${page - 1}, window.currentProducts)">‚Üê √ñnceki</button>`;
            }
            
            const startPage = Math.max(1, page - 2);
            const endPage = Math.min(totalPages, startPage + 4);
            
            for (let i = startPage; i <= endPage; i++) {
              paginationHTML += `<button class="btn btn-sm ${i === page ? 'btn-primary' : 'btn-outline-primary'}" onclick="window.showPage(${i}, window.currentProducts)">${i}</button>`;
            }
            
            if (page < totalPages) {
              paginationHTML += `<button class="btn btn-sm btn-outline-primary" onclick="window.showPage(${page + 1}, window.currentProducts)">Sonraki ‚Üí</button>`;
            }
            
            paginationDiv.innerHTML = paginationHTML;
            paginationDiv.style.display = 'flex';
          } else {
            paginationDiv.style.display = 'none';
          }
          
          window.currentPage = page;
        }
        
        // Global scope'a ta≈üƒ±
        window.showPage = function(page, products) {
          showPage(page, products);
        };
        
        function updateProductQty(productIndex, qty) {
          // Sadece adet g√ºncellemesi i√ßin kullanƒ±labilir, ≈üimdilik bo≈ü bƒ±rakƒ±yoruz
          // Asƒ±l ekleme i≈ülemi addProductToList'te yapƒ±lƒ±yor
        }
        
        async function addProductToList(productIndex) {
          if (productIndex === undefined) {
            showToast('√úr√ºn bulunamadƒ±', 'warning');
            return;
          }
          
          // Index ile √ºr√ºn bul
          const allProducts = window.currentProducts;
          const startIndex = (window.currentPage - 1) * productsPerPage;
          const product = allProducts[startIndex + productIndex];
          
          if (!product) {
            showToast('√úr√ºn bulunamadƒ±', 'warning');
            return;
          }
          
          const title = product.title || '';
          const brand = product.brand || '';
          const image_link = product.image_link || '';
          
          if (!title) {
            showToast('√úr√ºn adƒ± bulunamadƒ±', 'warning');
            return;
          }
          
          // Adet deƒüerini al
          const qtyInput = document.getElementById(`qty-${productIndex}`);
          const adet = qtyInput ? parseInt(qtyInput.value) || 1 : 1;
          
          // Kategori se√ßimi i√ßin modal g√∂ster
          const kategori = await showCategoryModal();
          
          if (!kategori) {
            return; // Kullanƒ±cƒ± iptal etti
          }
          
          try {
            // Manuel ekleme API'sini kullan
            const res = await fetch('/api/eklenenler/manual_add', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                kategori: kategori,
                title: title,
                brand: brand,
                image_link: image_link,
                adet: adet
              })
            });
            
            const data = await res.json();
            
            if (res.ok && data.ok) {
              showToast(`√úr√ºn eklendi: ${title} (${kategori === 'barkodsuz' ? 'Barkodsuz' : 'Hasarlƒ±'})`, 'success');
              updateStats(data.stats);
              renderEklenenler(data.eklenenler || []);
            } else {
              showToast(data.message || '√úr√ºn eklenemedi', 'danger');
            }
          } catch (error) {
            console.error('Ekleme hatasƒ±:', error);
            showToast('√úr√ºn eklenirken hata olu≈ütu', 'danger');
          }
        }
        
        // Kategori se√ßim modalƒ±
        function showCategoryModal() {
          return new Promise((resolve) => {
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            backdrop.style.zIndex = '1040';
            
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.style.zIndex = '1050';
            modal.setAttribute('tabindex', '-1');
            modal.setAttribute('aria-modal', 'true');
            modal.setAttribute('role', 'dialog');
            modal.innerHTML = `
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Kategori Se√ßin</h5>
                    <button type="button" class="btn-close" onclick="closeCategoryModal()" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <p>√úr√ºn√º hangi kategoriye eklemek istersiniz?</p>
                    <div class="d-grid gap-2">
                      <button class="btn btn-primary" onclick="selectCategory('barkodsuz')">Barkodsuz</button>
                      <button class="btn btn-danger" onclick="selectCategory('hasarli')">Hasarlƒ±</button>
                    </div>
                  </div>
                </div>
              </div>
            `;
            
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
            
            window.closeCategoryModal = function() {
              document.body.removeChild(backdrop);
              document.body.removeChild(modal);
              document.body.style.overflow = '';
              resolve(null);
            };
            
            window.selectCategory = function(kategori) {
              document.body.removeChild(backdrop);
              document.body.removeChild(modal);
              document.body.style.overflow = '';
              resolve(kategori);
            };
          });
        }
        
        // Global scope'a ta≈üƒ±
        window.addProductToList = addProductToList;
        window.updateProductQty = updateProductQty;
      }
      window.addEventListener('DOMContentLoaded', mount);
    </script>
  </body>
</html>
